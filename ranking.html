<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memoro - Progress</title>

  <!-- Global styles -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style/style.css" />
  <link rel="stylesheet" href="/style/header.css" />
  <link rel="stylesheet" href="/style/footer.css" />

  <!-- Global fade-in -->
  <script defer src="/scripts/global-fade-in.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<script>
  // Load reusable header
  document.addEventListener("DOMContentLoaded", () => {
    fetch('components/header.html')
      .then(res => res.text())
      .then(data => {
        document.body.insertAdjacentHTML('afterbegin', data);

        const backdropEl = document.createElement('div');
        backdropEl.classList.add('nav-backdrop');
        document.body.appendChild(backdropEl);

        const toggleBtn = document.querySelector('.mobile-nav-toggle');
        const menu = document.querySelector('.header-menu');

        if (!toggleBtn || !menu) return;

        const toggleMenu = () => {
          toggleBtn.classList.toggle('open');
          menu.classList.toggle('open');
          backdropEl.classList.toggle('active');
        };

        toggleBtn.addEventListener('click', toggleMenu);
        backdropEl.addEventListener('click', toggleMenu);
      })
      .catch(err => console.error('Failed to load header:', err));
  });
</script>

<main class="page-content fade-in-on-load">
  <h1 class="main-title">Your Progress</h1>

  <div class="games-carousel-wrapper">
    <div id="game-buttons" class="games-carousel"></div>
  </div>

  <div class="chart-container">
    <canvas id="progressChart"></canvas>
    <div id="noDataMessageWrapper" class="no-data-wrapper">
      <div class="additional-message">Please play and finish a game to start tracking and analyzing your progress.</div>
    </div>
  </div>

  <div class="games-carousel-wrapper">
    <div id="progress-filter-buttons" class="games-carousel">
      <button class="progress-filter-button active" data-range="today">Today's Progress</button>
      <button class="progress-filter-button" data-range="week">Week's Progress</button>
      <button class="progress-filter-button" data-range="month">Monthly Progress</button>
      <button class="progress-filter-button" data-range="year">Yearly Progress</button>
    </div>
  </div>
</main>

<script>
let chartInstance = null;
let filteredSessions = [];
let allSessions = JSON.parse(localStorage.getItem("gameSessions") || "[]");

function filterByDateRange(range) {
  const now = new Date();
  return allSessions.filter(session => {
    try {
      const [day, month, year] = session.date.split("/");
      const [hour, minute] = session.time.split(":");
      const sessionDate = new Date(year, month - 1, day, hour, minute);
      switch (range) {
        case 'today': return sessionDate.toDateString() === now.toDateString();
        case 'week':  return sessionDate >= new Date(now.setDate(now.getDate() - 7));
        case 'month': return sessionDate >= new Date(now.setMonth(now.getMonth() - 1));
        case 'year':  return sessionDate >= new Date(now.setFullYear(now.getFullYear() - 1));
        default: return true;
      }
    } catch (e) {
      return false;
    }
  });
}

function highlightProgressFilter(button) {
  document.querySelectorAll('.progress-filter-button').forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
}

function updateGraph(gameId, range = 'all') {
  const canvas = document.getElementById('progressChart');
  const ctx = canvas.getContext('2d');
  const noDataMessageWrapper = document.getElementById('noDataMessageWrapper');

  let sessions = allSessions.filter(session => session.gameType === gameId);
  if (range !== 'all') sessions = filterByDateRange(range).filter(s => s.gameType === gameId);
  filteredSessions = sessions;

  if (chartInstance) chartInstance.destroy();

  if (sessions.length === 0) {
    canvas.style.display = 'none';
    noDataMessageWrapper.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  noDataMessageWrapper.style.display = 'none';

  const labels = sessions.map((_, i) => i + 1);
  const dataPoints = sessions.map(s => s.scorePercent);

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Score %',
        data: dataPoints,
        backgroundColor: 'rgba(124, 58, 237, 0.4)',
        borderColor: 'rgba(124, 58, 237, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointBackgroundColor: 'white',
        pointBorderColor: 'rgba(124, 58, 237, 1)',
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: { stepSize: 10 },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          type: 'linear',
          position: 'bottom',
          ticks: { display: false },
          grid: { display: false },
          title: { display: false }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#e6e8eb',
            font: { size: 14 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const session = filteredSessions[context.dataIndex];
              return [
                `Score: ${session.scorePercent}%`,
                `Correct: ${session.correctCount}`,
                `Incorrect: ${session.incorrectCount}`,
                `Time: ${session.timeSpent}s`,
                `${session.date} ${session.time}`
              ];
            }
          }
        }
      }
    }
  });
}

function highlightActiveButton(activeButton) {
  document.querySelectorAll('.game-results-buttons').forEach(btn => btn.classList.remove('active'));
  if (activeButton) activeButton.classList.add('active');
}

async function loadGameButtons() {
  const container = document.getElementById('game-buttons');
  try {
    const res = await fetch('/gamescollection/games.json');
    const games = (await res.json()).filter(g => g.category !== "Vault");
    container.innerHTML = '';
    games.forEach(game => {
      const btn = document.createElement('button');
      btn.classList.add('game-results-buttons');
      btn.textContent = game.title;
      btn.onclick = () => {
        updateGraph(game.id, getCurrentRange());
        highlightActiveButton(btn);
      };
      container.appendChild(btn);
    });
    if (games.length > 0) {
      updateGraph(games[0].id, getCurrentRange());
      highlightActiveButton(container.querySelector('button'));
    }
  } catch (e) {
    console.error('Failed to load games:', e);
    container.innerHTML = '<p style="color: #aaa; text-align: center;">Failed to load games.</p>';
  }
}

function getCurrentRange() {
  const active = document.querySelector('.progress-filter-button.active');
  return active ? active.dataset.range : 'all';
}

function setupRangeButtons() {
  document.querySelectorAll('.progress-filter-button').forEach(button => {
    button.addEventListener('click', () => {
      highlightProgressFilter(button);
      const activeGameBtn = document.querySelector('.game-results-buttons.active');
      if (activeGameBtn) {
        const gameTitle = activeGameBtn.textContent;
        fetch('/gamescollection/games.json')
          .then(res => res.json())
          .then(games => {
            const selectedGame = games.find(g => g.title === gameTitle);
            if (selectedGame) updateGraph(selectedGame.id, button.dataset.range);
          });
      }
    });
  });
}

window.addEventListener('DOMContentLoaded', () => {
  loadGameButtons();
  setupRangeButtons();
});
</script>

<!-- Footer -->
<div id="site-footer"></div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch('/components/footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('site-footer').innerHTML = html;
      })
      .catch(err => console.error('Failed to load footer:', err));
  });
</script>

</body>
</html>
